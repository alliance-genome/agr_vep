# SIFT / PolyPhen Protein Function Annotation Pipeline

- Generates databases of SIFT and PolyPhen scores and predictions for the MOD species.  
- Databases are accessed by a VEP plugin to add SIFT/PolyPhen annotation to the VEP output.
- Translated protein sequences are constructed from FASTA, GFF, and (optionally) BAM files.
- Serialized prediction matrices are stored containing all possible amino acid substitutions for each sequence, accessed by the hex md5 of the sequence.
- FULL mode generates the database from scratch.
- UPDATE mode checks for existing prediction matrices, or sequences for which there were valid reasons for being unable to generate protein function annotations, and updates the database for new sequences only.


## Requirements

See the links below for associated dependencies and required databases

- SIFT (see INSTALL file in download)
- PolyPhen-2 (see INSTALL file in download)
- EnsEMBL Hive ([eHive docs](https://ensembl-hive.readthedocs.io/en/version2.5/quickstart/install.html))
- EnsEMBL VEP ([VEP docs](https://m.ensembl.org/info/docs/tools/vep/script/vep_download.html#installer))

Perl libraries:
- File::Copy
- File::Path
- Data::Dumper
- Digest::MD5
- Bioperl


## Current versions

- BLAST+ 2.10.0
- BLAT 36x5
- SIFT 6.2.1
- PolyPhen-2 2.2.2r405d
- MAFFT 7.221
- UniRef90 2020_03
- Uniref100 2020_03
- Uniprot 2020_03
- Pfam 33.1


## Installation

### SIFT installation

Follow the instructions in the INSTALL file found in the SIFT install folder.  No special setup is required.

### PolyPhen installation

- Follow the instructions in the INSTALL and README files found in the PolyPhen install folder for setting up PolyPhen2 with non-human species, with the below caveats.
- Use `update_polyphen_uniprot.pl` from this repository in place of `$PPH/update/uniprot.pl` as the UniProt download format has changed. 
- Add the following to the `%SPECIES` hash in `$PPH/update/unipfam.pl':
    roundworm' => {
        'os' => 'Caenorhabditis elegans',
        'spname' => 'CAEEL',
        'taxn' => 6239,
        'file' => 'invertebrates',
    },                                                                                                                                                                                                  
    'yeast' => {
        'os' => 'Saccharomyces cerevisiae',
        'spname' => 'YEAST',
        'taxn' => 559292,
        'file' => 'fungi',
    },
- Change line 236 of `$PPH/update/unipfam.pl` from `die "ERROR: createdb: Missing or empty data file: $datafile\n" unless -s $datafile;` to `die "ERROR: createdb: Missing data file: $datafile\n" unless -e $datafile;`. Yeast and fruitfly don't have any domains in the swisspfam downloaded by this script.  To avoid errors when running PolyPhen, we want an empty pfam table to be created rather than the script dying.
- Create species-specific config files.  These need to be saved in folders that are specified by `pph_conf_dir` in the initialisation script.  The changes required are listed below.
- Change `UNIPROT` to the location of the uniref100 BLAST database in `databases.cnf`
- Change `REFORGANISM` and `REFORGCOMMON` to the appropriate species in `options.cnf`
- Change `SCRATCH`, `PRECOMPATH`, and `TMP_OUT` to `./scratch`, `./precomputed`, and `./polyphen_tmp` in `paths.cnf`

### Creation of databases for storing SIFT and PolyPhen scores

A separate MySQL database for each MOD needs to be created, named `mqt_vep_protein_function_MOD`.
- Change the MOD in `create_pfdb.sql` and use this to create each database.
- These databases should be set up on the same server as the eHive pipeline databases.


## Running the pipeline

The following variables need to be set in the `initialise_pipeline.sh` script:
- `mod` - name of the MOD, eg. WB.
- `agr_fasta` - FASTA file containing genome sequence.
- `agr_gff` - GFF3 file containing genome annotations.
- `agr_bam` - BAM file containing alignments of transcripts against genome, required if GFF3 contains RefSeq transcripts (set to 0 if not required).
- `hive_root_dir` - root directory containing EnsEMBL eHive Perl modules.
- `pipeline_base_dir` - location for files generated by pipeline to be saved.
- `pipeline_host` - MySQL database server for pipeline databases.
- `pipeline_user` - MySQL user.
- `pipeline_port` - MySQL server port.
- `lsf_queue` - name of the LSF queue used for running jobs on the cluster.
- `sift_dir` - SIFT installation directory.
- `pph_dir` - PolyPhen2 installation directory.
- `pph_conf_dir` - directory containing species-specific PolyPhen2 config files for the appropriate species.
- `ncbi_dir` - location of blastpgp
- `blastdb` - location of the protein database used to build alignments for SIFT (uniref90)

The pipeline should be initialised using the `runpipeline.sh` script.  The password for the MySQL databases needs to be specified as the first argument.
- Enter a `screen` or `tmux` session
- Run the pipeline initialisation script - e.g. `./initialise_pipeline.sh mysql_pass`.
- Copy and execute the appropriate line from the output to set the `$EHIVE_URL` environmental variable.
- Run the pipeline - `beekeeper.pl $EHIVE_URL -loop`.


## Pipeline runnable details

### InitJobs.pm

- Constructs translated sequences from MOD FASTA and GFF files.
- Calculates translation_md5.
- If UPDATE run, checks mqt_vep_protein_function_MOD database for translation_md5s with existing results (or valid failure reasons) for SIFT and PolyPhen2 analyses and only forwards appropriate md5s to runnables for each analysis.

### RunSift.pm

- Runs SIFT on single translation sequence.
- Input is translation_md5.
- Creates SIFT substitution file for all possible amino acid changes resulting from a single SNP, at all positions.
- Valid failure reasons are: insufficient sequence diversity in aligned sequences; not enough aligned sequences; not enough sequences found by PSI-BLAST.
- Stores results and valid failures in mqt_vep_protein_function_MOD database.
- SIFT prediction tagged as 'low quality' if median conservation score > 3.25 or number of sequences < 10.
- Deletes files after completion.

### UniprotAlign.pm

- Carries out BLASTP alignment of translation sequence against Uniref100.
- Checks if query sequence is (sub)sequence in Uniprot FASTA.
- If found then Uniprot accession used as ID and sequence used for BLAST.
- Stores result in appropriate directory for PolyPhen to see it and not attempt the alignment.

### RunPolyPhen2.pm

- Runs PPH on single translation sequence.
- Creates PPH substitution file for all possible amino acid changes resulting from a single SNP, at all positions.
- BLAST against Uniref100 already carried out and result copied to appropriate folder.
- Input is translation_md5.
- Output is translation_md5 and feature_file.
- Species-specific config files copied to working directory.
- No valid failure reasons currently set.

### RunWeka.pm

- Runs Weka on PPH output.
- Stores results in mqt_vep_protein_function_MOD database.
- Deletes PPH files after completion.
